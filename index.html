<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flux | External Brain</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#151e2e',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        brand: {
                            400: '#38bdf8', // Sky blue
                            500: '#0ea5e9',
                            600: '#0284c7',
                            glow: 'rgba(56, 189, 248, 0.5)'
                        }
                    },
                    animation: {
                        'enter': 'enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'wave': 'wave 1.2s ease-in-out infinite',
                    },
                    keyframes: {
                        enter: {
                            '0%': { opacity: '0', transform: 'translateY(10px) scale(0.98)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        },
                        wave: {
                            '0%, 100%': { height: '20%' },
                            '50%': { height: '100%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset & Variables */
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(15, 23, 42, 0.65);
            --glass-highlight: rgba(255, 255, 255, 0.03);
        }

        body {
            background-color: #020617;
            color: #f1f5f9;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden; /* Prevent body scroll, handle in containers */
            height: 100vh;
            width: 100vw;
        }

        /* Glassmorphism */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
        }

        .glass-input {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-input:focus-within {
            background: rgba(30, 41, 59, 0.8);
            border-color: #38bdf8;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.15);
        }

        /* Audio Visualizer Bars */
        .wave-bar {
            width: 4px;
            background: #ef4444;
            border-radius: 99px;
            animation: wave 1s ease-in-out infinite;
        }
        .wave-bar:nth-child(1) { animation-delay: 0.0s; height: 40%; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 80%; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 50%; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 90%; }
        .wave-bar:nth-child(5) { animation-delay: 0.15s; height: 60%; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Custom Audio Player Styling */
        audio {
            width: 100%;
            height: 36px;
            filter: invert(1) hue-rotate(180deg) saturate(0.5);
            opacity: 0.9;
        }

        /* Interaction Tweaks */
        .tap-highlight-transparent {
            -webkit-tap-highlight-color: transparent;
        }

        .delete-swipe {
            transform: translateX(0);
            transition: transform 0.2s ease-out;
        }
        
        /* Mobile specific adjustments for input visibility */
        @media (max-width: 640px) {
            .mobile-input-raised {
                /* FIXED: Uses calc to add safe area ON TOP of base padding (2rem) */
                padding-bottom: calc(2rem + env(safe-area-inset-bottom, 20px));
            }
        }
    </style>
</head>
<body class="flex flex-col relative selection:bg-brand-500 selection:text-white">

    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[80vw] h-[80vw] bg-blue-900/20 rounded-full blur-[120px] mix-blend-screen animate-pulse-slow"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[80vw] h-[80vw] bg-indigo-900/10 rounded-full blur-[120px] mix-blend-screen"></div>
        <div class="absolute top-[40%] left-[50%] transform -translate-x-1/2 w-[60vw] h-[60vw] bg-cyan-900/10 rounded-full blur-[100px]"></div>
    </div>

    <header class="flex-none px-6 pt-8 pb-4 w-full max-w-3xl mx-auto flex justify-between items-end z-10">
        <div>
            <div class="text-xs font-mono text-brand-400 mb-1 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-brand-400 shadow-[0_0_10px_#38bdf8]"></span>
                <span id="date-display">LOADING...</span>
            </div>
            <h1 class="text-3xl font-bold tracking-tight text-white bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
                Flux
            </h1>
        </div>
        <div class="text-right">
            <div id="task-progress" class="text-xs text-slate-400 font-mono">0/0</div>
            <div class="w-24 h-1 bg-slate-800 rounded-full mt-2 overflow-hidden">
                <div id="progress-bar" class="h-full bg-brand-500 w-0 transition-all duration-500 ease-out"></div>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-hidden w-full max-w-3xl mx-auto relative flex flex-col">
        
        <div id="task-container" class="flex-1 overflow-y-auto custom-scroll px-4 pb-32 pt-2 scroll-smooth">
            
            <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-slate-600 space-y-4 min-h-[40vh]">
                <div class="w-16 h-16 rounded-2xl bg-slate-800/50 flex items-center justify-center mb-2 border border-slate-700/50">
                    <i class="fa-solid fa-wind text-2xl text-slate-500"></i>
                </div>
                <p class="text-sm font-medium">Flow state active. No tasks pending.</p>
            </div>

            <ul id="task-list" class="space-y-3">
                </ul>
        </div>

        <div class="absolute bottom-0 left-0 w-full p-4 pb-8 md:pb-6 z-20 bg-gradient-to-t from-[#020617] via-[#020617]/95 to-transparent mobile-input-raised">
            <div class="w-full max-w-3xl mx-auto relative">
                
                <div id="input-bar" class="glass-input rounded-2xl flex items-center p-1.5 pr-2 shadow-2xl relative z-10">
                    
                    <input 
                        type="text" 
                        id="task-input" 
                        class="flex-1 bg-transparent border-none text-white placeholder-slate-500 focus:ring-0 text-base md:text-lg px-4 py-3 min-w-0" 
                        placeholder="Capture thought..." 
                        autocomplete="off"
                    >
                    
                    <div class="w-px h-8 bg-slate-700 mx-2"></div>

                    <button 
                        id="mic-btn" 
                        class="w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700/50 transition-colors tap-highlight-transparent"
                        aria-label="Record voice note"
                    >
                        <i class="fa-solid fa-microphone text-sm"></i>
                    </button>

                    <button 
                        id="add-btn" 
                        class="ml-2 w-10 h-10 rounded-xl bg-brand-600 hover:bg-brand-500 text-white flex items-center justify-center shadow-lg shadow-brand-500/20 transition-all active:scale-95 tap-highlight-transparent"
                        aria-label="Add task"
                    >
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>

                <div id="recording-bar" class="hidden absolute inset-0 glass-input rounded-2xl flex items-center justify-between p-2 z-20 border border-red-500/30 bg-slate-900/90">
                    <div class="flex items-center pl-4 gap-3">
                        <div class="flex items-center gap-1 h-8 w-12 justify-center">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                        <span id="recording-timer" class="font-mono text-red-400 text-sm tracking-wider">00:00</span>
                    </div>

                    <div class="flex items-center gap-2">
                        <button 
                            id="cancel-rec" 
                            class="px-4 py-2 text-xs font-medium text-slate-400 hover:text-white transition-colors uppercase tracking-wider"
                        >
                            Cancel
                        </button>
                        <button 
                            id="save-rec" 
                            class="w-10 h-10 rounded-xl bg-red-500 text-white flex items-center justify-center shadow-lg shadow-red-500/20 active:scale-95 transition-transform"
                        >
                            <i class="fa-solid fa-check"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        class FluxApp {
            constructor() {
                // DOM Elements
                this.elements = {
                    input: document.getElementById('task-input'),
                    addBtn: document.getElementById('add-btn'),
                    micBtn: document.getElementById('mic-btn'),
                    taskList: document.getElementById('task-list'),
                    taskContainer: document.getElementById('task-container'),
                    emptyState: document.getElementById('empty-state'),
                    inputBar: document.getElementById('input-bar'),
                    recordingBar: document.getElementById('recording-bar'),
                    recordingTimer: document.getElementById('recording-timer'),
                    cancelRecBtn: document.getElementById('cancel-rec'),
                    saveRecBtn: document.getElementById('save-rec'),
                    dateDisplay: document.getElementById('date-display'),
                    progressBar: document.getElementById('progress-bar'),
                    progressText: document.getElementById('task-progress'),
                };

                // State
                this.tasks = JSON.parse(localStorage.getItem('flux_tasks')) || [];
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.timerInterval = null;
                this.startTime = null;

                this.init();
            }

            init() {
                this.updateDate();
                this.renderTasks();
                this.attachEventListeners();
                
                // Focus handling for desktop
                if (window.matchMedia("(min-width: 768px)").matches) {
                    this.elements.input.focus();
                }
            }

            updateDate() {
                const now = new Date();
                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                this.elements.dateDisplay.textContent = now.toLocaleDateString('en-US', options).toUpperCase();
            }

            attachEventListeners() {
                // Add Task Text
                this.elements.addBtn.addEventListener('click', () => this.addTask());
                this.elements.input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addTask();
                });

                // Audio Recording
                this.elements.micBtn.addEventListener('click', () => this.startRecording());
                this.elements.cancelRecBtn.addEventListener('click', () => this.cancelRecording());
                this.elements.saveRecBtn.addEventListener('click', () => this.stopRecording());

                // Task Interactions (Delegation)
                this.elements.taskList.addEventListener('click', (e) => {
                    const item = e.target.closest('li');
                    if (!item) return;
                    const id = item.dataset.id;

                    if (e.target.closest('.delete-action')) {
                        this.deleteTask(id);
                    } else if (e.target.closest('.check-action') || e.target.closest('.task-content')) {
                        this.toggleTask(id);
                    }
                });
            }

            // --- Core Task Logic ---

            saveToStorage() {
                try {
                    localStorage.setItem('flux_tasks', JSON.stringify(this.tasks));
                } catch (e) {
                    alert('Storage full. Please delete some voice notes.');
                }
                this.renderTasks();
            }

            addTask() {
                const text = this.elements.input.value.trim();
                if (!text) return;

                const task = {
                    id: Date.now().toString(),
                    type: 'text',
                    content: text,
                    created: Date.now(),
                    completed: false
                };

                this.tasks.unshift(task);
                this.elements.input.value = '';
                this.saveToStorage();
                
                // Scroll to top
                this.elements.taskContainer.scrollTo({ top: 0, behavior: 'smooth' });
            }

            addAudioTask(base64Audio) {
                const task = {
                    id: Date.now().toString(),
                    type: 'audio',
                    content: base64Audio,
                    created: Date.now(),
                    completed: false
                };
                this.tasks.unshift(task);
                this.saveToStorage();
                this.elements.taskContainer.scrollTo({ top: 0, behavior: 'smooth' });
            }

            deleteTask(id) {
                const el = document.querySelector(`li[data-id="${id}"]`);
                if(el) {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        this.tasks = this.tasks.filter(t => t.id !== id);
                        this.saveToStorage();
                    }, 300);
                }
            }

            toggleTask(id) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    this.saveToStorage();
                }
            }

            // --- Recording Logic ---

            async startRecording() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Microphone not supported on this device/browser.');
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];

                    this.mediaRecorder.ondataavailable = e => this.audioChunks.push(e.data);
                    
                    this.mediaRecorder.start();
                    this.uiSetRecording(true);
                    this.startTimer();

                } catch (err) {
                    console.error(err);
                    alert('Please allow microphone access to record voice notes.');
                }
            }

            stopRecording() {
                if (!this.mediaRecorder) return;
                
                this.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        this.addAudioTask(reader.result);
                    };
                    this.cleanupRecording();
                };
                
                this.mediaRecorder.stop();
            }

            cancelRecording() {
                if (this.mediaRecorder) {
                    this.mediaRecorder.onstop = () => this.cleanupRecording();
                    this.mediaRecorder.stop();
                } else {
                    this.cleanupRecording();
                }
            }

            cleanupRecording() {
                if(this.mediaRecorder) {
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                this.uiSetRecording(false);
                this.stopTimer();
            }

            uiSetRecording(isRecording) {
                if (isRecording) {
                    this.elements.inputBar.classList.add('invisible');
                    this.elements.recordingBar.classList.remove('hidden');
                    this.elements.recordingBar.classList.add('flex');
                } else {
                    this.elements.inputBar.classList.remove('invisible');
                    this.elements.recordingBar.classList.add('hidden');
                    this.elements.recordingBar.classList.remove('flex');
                }
            }

            startTimer() {
                this.startTime = Date.now();
                this.elements.recordingTimer.innerText = "00:00";
                this.timerInterval = setInterval(() => {
                    const diff = Math.floor((Date.now() - this.startTime) / 1000);
                    const m = Math.floor(diff / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    this.elements.recordingTimer.innerText = `${m}:${s}`;
                }, 1000);
            }

            stopTimer() {
                clearInterval(this.timerInterval);
            }

            // --- Rendering ---

            renderTasks() {
                const list = this.elements.taskList;
                list.innerHTML = '';

                // Calculate Progress
                const total = this.tasks.length;
                const completed = this.tasks.filter(t => t.completed).length;
                this.elements.progressText.innerText = `${completed}/${total}`;
                this.elements.progressBar.style.width = total === 0 ? '0%' : `${(completed / total) * 100}%`;

                // Empty State
                if (total === 0) {
                    this.elements.emptyState.classList.remove('hidden');
                    return;
                }
                this.elements.emptyState.classList.add('hidden');

                // Sort: Pending first, then by time
                const sortedTasks = [...this.tasks].sort((a, b) => {
                    if (a.completed === b.completed) return b.created - a.created;
                    return a.completed ? 1 : -1;
                });

                sortedTasks.forEach((task, index) => {
                    const li = document.createElement('li');
                    li.dataset.id = task.id;
                    li.className = `group animate-enter transition-all duration-300 ${task.completed ? 'opacity-50' : 'opacity-100'}`;
                    li.style.animationDelay = `${index * 50}ms`;

                    const date = new Date(task.created);
                    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' }).toLowerCase();

                    // HTML Content Generation
                    let contentHtml = '';
                    if (task.type === 'text') {
                        contentHtml = `<div class="task-content text-sm md:text-base font-medium text-slate-100 break-words leading-relaxed cursor-pointer select-none ${task.completed ? 'line-through text-slate-500' : ''}">${this.escapeHtml(task.content)}</div>`;
                    } else {
                        contentHtml = `
                            <div class="w-full">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-[10px] font-bold text-brand-400 uppercase tracking-widest bg-brand-900/30 px-2 py-0.5 rounded border border-brand-500/20">Voice Note</span>
                                </div>
                                <audio controls src="${task.content}" class="w-full rounded-lg"></audio>
                            </div>
                        `;
                    }

                    li.innerHTML = `
                        <div class="glass-panel p-4 rounded-xl flex items-start gap-4 hover:border-slate-600 transition-colors relative overflow-hidden">
                            <button class="check-action mt-1 flex-shrink-0 w-5 h-5 rounded-full border-2 ${task.completed ? 'bg-green-500 border-green-500' : 'border-slate-500 hover:border-brand-400'} flex items-center justify-center transition-all">
                                <i class="fa-solid fa-check text-xs text-white ${task.completed ? 'opacity-100' : 'opacity-0'}"></i>
                            </button>

                            <div class="flex-1 min-w-0 flex flex-col gap-1">
                                ${contentHtml}
                                <div class="text-[10px] font-mono text-slate-500 mt-1">${timeStr}</div>
                            </div>

                            <button class="delete-action w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:bg-red-500/10 hover:text-red-400 transition-colors opacity-100 md:opacity-0 group-hover:opacity-100 focus:opacity-100 absolute top-2 right-2 md:static md:w-auto md:h-auto md:bg-transparent">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                        </div>
                    `;

                    list.appendChild(li);
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new FluxApp();
        });
    </script>
</body>
</html>
